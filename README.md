# Описание API очередей

## Условные названия и обозначения

* *Консюмер* - процесс, выполняющий задачи
* *Продюсер* - процесс, ставящий задачи в очередь

### Параметры функций

* `space` (С,Ч) номер спейса. Необходимо придерживаться единообразия
в использовании строк или чисел в этом поле во избежание получения
"двойной статистики".
* `tube` (С) - имя очереди.
* `delay` (С,Ч) - задержка до выполнения задачи. В секундах.
* `ttl` (C,Ч) - время жизни задачи. В секундах. Если одновременно с этим
полем указано ненулевое `delay`, то `ttl` будет увеличено на величину `delay`.
* `ttr` (С,Ч) - максимальное время выполнения для задачи.
* `pri` (С,Ч) - приоритет (`-127 .. +127`).
* `id` (С) - идентификатор задачи.
* `timeout` (С,Ч) - таймаут для операции. В секундах.

### Статусы задач

* `ready` - задача готова к исполнению
* `delayed` - задача ожидает пока истечет время задержки до выполнения
* `taken` - задача исполняется
* `done` - задача выполнена (но не удалена, поскольку вызван метод `done`)
* `buried` - задача исключена из списка выполняемых


## API


### Продюсер

#### queue.put(space, tube, delay, ttl, ttr, pri, ...)

Метод размещает задачу в очереди. Возвращает итоговую задачу (`id` + данные).
Данные могут не использоваться.

#### queue.urgent(space, tube, delay, ttl, ttr, pri, ...)

Метод размещает задачу в очереди. Отличается от `put` тем что размещает задачу
для немедленного выполнения. В случае если указан ненулевой `delay`, то данный
метод полностью эквивалентен `put`.

### Консюмер

#### queue.take(space, tube, timeout)

Метод ожидает появление задачи в очереди (если таймаут не указан, то ожидает
до бесконечности). При появлении задачи она помечается как `taken` и
возвращается консюмеру. Все время, пока консюмер выполняет задачу он не должен
разрывать соединение, поскольку в ответ на разрыв соединения задаче будет
возвращен статус `ready` (готова к исполнению).

#### queue.ack(space, id)

Информирует очередь о том что задача выполнена. Может выбрасывать исключения
в случаях:

* задача не помечена как выполняющаяся (`taken`)
* задачу брал другой консюмер (только тот консюмер что брал задачу на
выполнение может выполнять метод `ack` для нее)

Вызов данного метода приводит к удалению задачи из очереди.

#### queue.release(space, id [, delay [, ttl ] ])

Возвращает задачу обратно в очередь неисполненной. Можно указать интервал
на который надо отложить повторное выполнение, а так же новый `ttl`.

#### queue.requeue(space, id)

Возвращает задачу обратно в очередь неисполненной. При этом кладет задачу
в конец очереди с тем чтобы повторно она выполнялась только после тех задач
что уже накопились в очереди.

#### queue.bury(space, id)

Помечает задачу как исключенную из списка выполняемых (например после серии
ошибок по выполнению данной задачи).


#### queue.done(space, id, ...)

Помечает задачу как выполненную (`done`), заменяет задаче данные на указанные.


### Общие методы

#### queue.dig(space, id)

Снимает с задачи пометку об исключенности из списка выполняемых.

#### queue.kick(space, tube [, count] )

Снимает с указанного количества задач пометку об исключенности из списка
выполняемых. Если `count` не указан, то обрабатывает не более одной задачи.

#### queue.unbury(space, id)

Синоним `dig`

#### queue.delete(space, id)

Удаляет задачу из очереди.

#### queue.meta(space, id)

Возвращает метаинформацию о задаче. Состоит из следующих полей (по порядку)

1. `id` (С) - идентификатор задачи
1. `tube` (С) - название очереди
1. `status` (С) - статус задачи
1. `event` (time64) - время когда произойдет следующее событие, связанное
с данной задачей (например истечет время `ttl` или `ttr`)
1. `ipri` (С) - внутренний приоритет задачи (пользователь не может им управлять)
1. `pri` (С) - приоритет задачи выставленный при ее помещении в очередь
1. `cid` (Ч) - идентификатор консюмера, котрый взял задачу на выполнение
(только для случая `taken`)
1. `created` (time64) - когда задача была создана в очереди
1. `ttl` (time64) - время жизни задачи
1. `ttr` (time64) - максимальный интервал обработки задачи
1. `cbury` (Ч) - сколько раз задача переводилась в статус `buried`
1. `ctaken` (Ч) - сколько раз задача бралась на исполнение
1. `now` (time64) - временная метка на момент вызова `meta`

#### queue.peek(space, id)

Возвращает задачу по ее идентификатору.

#### queue.statistic()

Возвращает статистику накопленную с момента старта очереди.
Статистика возвращается только по тем очередям в которых были хоть какие-то
запросы с момента старта тарантула.

Статистика возвращается в виде набора строк. Каждая нечетная строка - название
счетчика/параметра. Каждая четная строка - значение.
