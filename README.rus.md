# Схема очереди

Очередь работает со спецспейсом `_queue`, который либо создает
сама при первом `init`, либо использует созданный ей же ранее.

## Структура спейса `_queue`

1. `tube` - имя очереди
1. `tube_id` - числовой ID очереди
1. `space` - имя спейса, связанного с очередью
1. `type` - тип очереди
1. `opts` - дополнительные опции по данной очереди

Так же создается два спецспейса с флагом `temporary = true`:

## Список ожидающих заданий консьюмеров

1. `session` - id сессии в которой пришел клиент
1. `fid` - id файбера клиента
1. `tube_id` - id очереди, которую ждет данный клиент
1. `timeout` - когда у клиента истечет терпение и он уйдет
1. `time` - когда клиент начал ждать


## Список задач находящихся на выполнении

1. `session` - id сессии с которой пришел клиент
1. `tube_id` - id очереди в которой он выполняет сейчас таск
1. `task_id` - id задачи, которую он сейчас выполняет
1. `time` - когда он начал выполнять задачу

# API


## Подключение очереди

```lua
    local queue = require 'queue'
```

Операция `require` создает спецспейс `_queue` (если он не создан), а так
же устанавливает все необходимые триггеры итп.

## Создание очереди

```
    queue.schema.create_tube(name, type, { ... })
```

Создает очередь.

Пока поддерживаются следующие типы:

1. `fifo` - таски обрабатываются в порядке поступления.
нарушение порядка возможно только при наличии нескольких воркеров, которые
работают с разной скоростью и (или) отваливаются.
1. `pri` - очередь с приоритетами.
