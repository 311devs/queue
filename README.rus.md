# Схема очереди

Очередь работает со спецспейсом `_queue`, который либо создает
сама при первом `init`, либо использует созданный ей же ранее.

## Структура спейса `_queue`

1. `tube` - имя очереди
1. `tube_id` - числовой ID очереди
1. `space` - имя спейса, связанного с очередью
1. `type` - тип очереди
1. `opts` - дополнительные опции по данной очереди

Так же создается два спецспейса с флагом `temporary = true`:

## Список ожидающих заданий консьюмеров

1. `session` - id сессии в которой пришел клиент
1. `fid` - id файбера клиента
1. `tube_id` - id очереди, которую ждет данный клиент
1. `timeout` - когда у клиента истечет терпение и он уйдет
1. `time` - когда клиент начал ждать


## Список задач находящихся на выполнении

1. `session` - id сессии с которой пришел клиент
1. `tube_id` - id очереди в которой он выполняет сейчас таск
1. `task_id` - id задачи, которую он сейчас выполняет
1. `time` - когда он начал выполнять задачу

# API


## Подключение очереди

```lua
    local queue = require 'queue'
```

Операция `require` создает спецспейс `_queue` (если он не создан), а так
же устанавливает все необходимые триггеры итп.

## Создание очереди

```
    queue.schema.create_tube(name, type, { ... })
```

Создает очередь.

Пока поддерживаются следующие типы:

1. `fifo` - таски обрабатываются в порядке поступления.
нарушение порядка возможно только при наличии нескольких воркеров, которые
работают с разной скоростью и (или) отваливаются.
1. `fifottl` - таски обрабатываются в порядке поступления.
Таски и очередь в настройках имеют предзаданное время жизни (`ttl`) и время
исполнения (`ttr`).

## Продюсер

Положить таск в очередь можно командой

```lua
queue.tube.tube_name:put(task_data[, opts])
```

Опции `opts` в общем случае необязательны, если не указаны, то берутся из
общих настроек очереди (или устанавливаются в то или иное дефолтное значение).

Общие для всех очередей опции (разные очереди могут не поддерживать те или иные
опции):

* `ttl` - время жизни таска в секундах. Спустя данное время, если таск не был
взят ни одним консьюмером таск удаляется из очереди.
* `ttr` - время отведенное на выполнение таска консьюмером. Если консюмер не
уложился в это время, то таск возвращается в состояние `READY` (и его сможет
взять на выполнение другой консюмер). По умолчанию равно `ttl`.
* `pri` - приоритет задачи.
* `delay` - отложить выполнение задачи на указанное число секунд.

Возвращает созданную задачу.

## Консюмер

Получить таск на выполнение можно командой

```lua
queue.tube.tube_name:take([timeout])
```

Ожидает `timeout` секунд до появления задачи в очереди.
Возвращает задачу или пустой ответ.


После выполнения задачи консюмером необходимо сделать для задачи `ack`:

```lua
queue.tube.tube_name:ack(task_id)
```

Необходимо отметить:

1. `ack` может делать только тот консюмер, который взял задачу на исполнение
1. при разрыве сессии с консюмером, все взятые им задачи переводятся в состояние
"готова к исполнению" (то есть им делается принудительный `release`)

Если консюмер по какой-то причине не может выполнить задачу, то он может
вернуть ее в очередь:

```lua
queue.tube.tube_name:release(task_id, opts)
```

в опциях можно передавать задержку на последующее выполнение (для очередей,
которые поддерживают отложенное исполнение) - `delay`.
